{"version":3,"file":"aes.js","names":["decodeBase64","encodeBase64","zeroSalt","Uint8Array","encryptAES","_x","_x2","_x3","_x4","_encryptAES","apply","arguments","_asyncToGenerator","data","key","name","ivStr","iv","globalThis","crypto","getRandomValues","aesKey","hmacKey","deriveKeys","encodedData","TextEncoder","encode","ciphertext","subtle","encrypt","counter","length","hmac","sign","mac","decryptAES","_x5","_x6","_x7","_decryptAES","verify","Error","concat","plaintext","decrypt","TextDecoder","decode","_x8","_x9","_deriveKeys","hkdfkey","importKey","keybits","deriveBits","salt","info","hash","slice","aesProm","hmacProm","Promise","all","ZERO_STR","calculateKeyCheck"],"sources":["../../src/crypto/aes.ts"],"sourcesContent":["/*\nCopyright 2020 - 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { decodeBase64, encodeBase64 } from \"../base64.ts\";\n\n// salt for HKDF, with 8 bytes of zeros\nconst zeroSalt = new Uint8Array(8);\n\nexport interface IEncryptedPayload {\n    [key: string]: any; // extensible\n    /** the initialization vector in base64 */\n    iv: string;\n    /** the ciphertext in base64 */\n    ciphertext: string;\n    /** the HMAC in base64 */\n    mac: string;\n}\n\n/**\n * encrypt a string\n *\n * @param data - the plaintext to encrypt\n * @param key - the encryption key to use\n * @param name - the name of the secret\n * @param ivStr - the initialization vector to use\n */\nexport async function encryptAES(\n    data: string,\n    key: Uint8Array,\n    name: string,\n    ivStr?: string,\n): Promise<IEncryptedPayload> {\n    let iv: Uint8Array;\n    if (ivStr) {\n        iv = decodeBase64(ivStr);\n    } else {\n        iv = new Uint8Array(16);\n        globalThis.crypto.getRandomValues(iv);\n\n        // clear bit 63 of the IV to stop us hitting the 64-bit counter boundary\n        // (which would mean we wouldn't be able to decrypt on Android). The loss\n        // of a single bit of iv is a price we have to pay.\n        iv[8] &= 0x7f;\n    }\n\n    const [aesKey, hmacKey] = await deriveKeys(key, name);\n    const encodedData = new TextEncoder().encode(data);\n\n    const ciphertext = await globalThis.crypto.subtle.encrypt(\n        {\n            name: \"AES-CTR\",\n            counter: iv,\n            length: 64,\n        },\n        aesKey,\n        encodedData,\n    );\n\n    const hmac = await globalThis.crypto.subtle.sign({ name: \"HMAC\" }, hmacKey, ciphertext);\n\n    return {\n        iv: encodeBase64(iv),\n        ciphertext: encodeBase64(ciphertext),\n        mac: encodeBase64(hmac),\n    };\n}\n\n/**\n * decrypt a string\n *\n * @param data - the encrypted data\n * @param key - the encryption key to use\n * @param name - the name of the secret\n */\nexport async function decryptAES(data: IEncryptedPayload, key: Uint8Array, name: string): Promise<string> {\n    const [aesKey, hmacKey] = await deriveKeys(key, name);\n\n    const ciphertext = decodeBase64(data.ciphertext);\n\n    if (!(await globalThis.crypto.subtle.verify({ name: \"HMAC\" }, hmacKey, decodeBase64(data.mac), ciphertext))) {\n        throw new Error(`Error decrypting secret ${name}: bad MAC`);\n    }\n\n    const plaintext = await globalThis.crypto.subtle.decrypt(\n        {\n            name: \"AES-CTR\",\n            counter: decodeBase64(data.iv),\n            length: 64,\n        },\n        aesKey,\n        ciphertext,\n    );\n\n    return new TextDecoder().decode(new Uint8Array(plaintext));\n}\n\nasync function deriveKeys(key: Uint8Array, name: string): Promise<[CryptoKey, CryptoKey]> {\n    const hkdfkey = await globalThis.crypto.subtle.importKey(\"raw\", key, { name: \"HKDF\" }, false, [\"deriveBits\"]);\n    const keybits = await globalThis.crypto.subtle.deriveBits(\n        {\n            name: \"HKDF\",\n            salt: zeroSalt,\n            // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n            // @ts-ignore: https://github.com/microsoft/TypeScript-DOM-lib-generator/pull/879\n            info: new TextEncoder().encode(name),\n            hash: \"SHA-256\",\n        },\n        hkdfkey,\n        512,\n    );\n\n    const aesKey = keybits.slice(0, 32);\n    const hmacKey = keybits.slice(32);\n\n    const aesProm = globalThis.crypto.subtle.importKey(\"raw\", aesKey, { name: \"AES-CTR\" }, false, [\n        \"encrypt\",\n        \"decrypt\",\n    ]);\n\n    const hmacProm = globalThis.crypto.subtle.importKey(\n        \"raw\",\n        hmacKey,\n        {\n            name: \"HMAC\",\n            hash: { name: \"SHA-256\" },\n        },\n        false,\n        [\"sign\", \"verify\"],\n    );\n\n    return Promise.all([aesProm, hmacProm]);\n}\n\n// string of zeroes, for calculating the key check\nconst ZERO_STR = \"\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\";\n\n/** Calculate the MAC for checking the key.\n *\n * @param key - the key to use\n * @param iv - The initialization vector as a base64-encoded string.\n *     If omitted, a random initialization vector will be created.\n * @returns An object that contains, `mac` and `iv` properties.\n */\nexport function calculateKeyCheck(key: Uint8Array, iv?: string): Promise<IEncryptedPayload> {\n    return encryptAES(ZERO_STR, key, \"\", iv);\n}\n"],"mappings":"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","ignoreList":[]}